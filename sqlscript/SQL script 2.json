{
	"name": "SQL script 2",
	"properties": {
		"content": {
			"query": "DROP PROCEDURE [dbo].[scd2_Incubation_Azure_target]\nGO\n\nSET ANSI_NULLS ON\nGO\nSET QUOTED_IDENTIFIER ON\nGO\n\nCREATE PROC [dbo].[scd2_Incubation_Azure_target] AS\nBEGIN\n MERGE  dbo.Incubation_Azure_target AS target  \n    USING \n\t(SELECT updates.id as mergeKey, \n\tupdates.id                        \n\t,cast(updates.date_time  as datetime)  as   date_time          \n\t,updates.site_name                \n\t,updates.posa_continent           \n\t,updates.user_location_country    \n\t,updates.user_location_region     \n\t,updates.user_location_city       \n\t,updates.orig_destination_distance\n\t,updates.user_id                  \n\t,updates.is_mobile                \n\t,updates.is_package               \n\t,updates.channel                  \n\t,updates.srch_ci                  \n\t,updates.srch_co                  \n\t,updates.srch_adults_cnt          \n\t,updates.srch_children_cnt        \n\t,updates.srch_rm_cnt              \n\t,updates.srch_destination_id      \n    ,updates.srch_destination_type_id \n    ,updates.hotel_id\n  \n  \n  \n  FROM dbo.expedia_hotel as updates\n  \n  UNION ALL\n  \n \n  SELECT NULL as mergeKey, updates.id                        \n\t,cast(updates.date_time  as datetime)  as   date_time          \n\t,updates.site_name                \n\t,updates.posa_continent           \n\t,updates.user_location_country    \n\t,updates.user_location_region     \n\t,updates.user_location_city       \n\t,updates.orig_destination_distance\n\t,updates.user_id                  \n\t,updates.is_mobile                \n\t,updates.is_package               \n\t,updates.channel                  \n\t,updates.srch_ci                  \n\t,updates.srch_co                  \n\t,updates.srch_adults_cnt          \n\t,updates.srch_children_cnt        \n\t,updates.srch_rm_cnt              \n\t,updates.srch_destination_id      \n    ,updates.srch_destination_type_id \n    ,updates.hotel_id\n  FROM dbo.expedia_hotel as updates JOIN dbo.Incubation_Azure_target as tgt\n  ON updates.id = tgt.id \n  WHERE tgt.current_flag = 'true' AND ( tgt.hotel_id <> updates.hotel_id\nor tgt.srch_destination_type_id <> updates.srch_destination_type_id\nor tgt.srch_destination_id <> updates.srch_destination_id\nor tgt.srch_rm_cnt <> updates.srch_rm_cnt\nor tgt.srch_children_cnt <> updates.srch_children_cnt\nor tgt.srch_adults_cnt <> updates.srch_adults_cnt\nor tgt.srch_co <> updates.srch_co\nor tgt.srch_ci <> updates.srch_ci\nor tgt.channel <> updates.channel\nor tgt.user_id <> updates.user_id\nor tgt.is_mobile <> updates.is_mobile\nor tgt.orig_destination_distance <> updates.orig_destination_distance\nor tgt.user_location_city <> updates.user_location_city\nor tgt.site_name <> updates.site_name\n)) AS staged_updates \n\t\n    ON (target.id = staged_updates.mergeKey\t)  \n    WHEN MATCHED AND target.current_flag = 'true' AND (target.site_name<> staged_updates.site_name \nor target.hotel_id <> staged_updates.hotel_id\nor target.srch_destination_type_id <> staged_updates.srch_destination_type_id\nor target.srch_destination_id <> staged_updates.srch_destination_id\nor target.srch_rm_cnt <> staged_updates.srch_rm_cnt\nor target.srch_children_cnt <> staged_updates.srch_children_cnt\nor target.srch_adults_cnt <> staged_updates.srch_adults_cnt\nor target.srch_co <> staged_updates.srch_co\nor target.srch_ci <> staged_updates.srch_ci\nor target.channel <> staged_updates.channel\nor target.user_id <> staged_updates.user_id\nor target.is_mobile <> staged_updates.is_mobile\nor target.orig_destination_distance <> staged_updates.orig_destination_distance\nor target.user_location_city <> staged_updates.user_location_city\nor target.site_name <> staged_updates.site_name\n) THEN\n     UPDATE SET current_flag = 'false', endDate = staged_updates.date_time\n    WHEN NOT MATCHED THEN \n  INSERT(\n  id                          \n  ,date_time                  \n  ,site_name                  \n  ,posa_continent             \n  ,user_location_country      \n  ,user_location_region       \n  ,user_location_city         \n  ,orig_destination_distance  \n  ,user_id                    \n  ,is_mobile                  \n  ,is_package                 \n  ,channel                    \n  ,srch_ci                    \n  ,srch_co                    \n  ,srch_adults_cnt            \n  ,srch_children_cnt          \n  ,srch_rm_cnt                \n  ,srch_destination_id        \n  ,srch_destination_type_id   \n  ,hotel_id\n  ,current_flag\n  ,endDate  \n  ) \n  VALUES(\n  staged_updates.id \n  ,staged_updates.date_time\n  ,staged_updates.site_name                  \n  ,staged_updates.posa_continent             \n  ,staged_updates.user_location_country      \n  ,staged_updates.user_location_region       \n  ,staged_updates.user_location_city         \n  ,staged_updates.orig_destination_distance  \n  ,staged_updates.user_id                    \n  ,staged_updates.is_mobile                  \n  ,staged_updates.is_package                 \n  ,staged_updates.channel                    \n  ,staged_updates.srch_ci                    \n  ,staged_updates.srch_co                    \n  ,staged_updates.srch_adults_cnt            \n  ,staged_updates.srch_children_cnt          \n  ,staged_updates.srch_rm_cnt                \n  ,staged_updates.srch_destination_id        \n  ,staged_updates.srch_destination_type_id   \n  ,staged_updates.hotel_id\n  ,'true'\n  ,null) ;\nEND;\nGO",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"poolName": "expediadedicated",
				"databaseName": "expediadedicated"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}